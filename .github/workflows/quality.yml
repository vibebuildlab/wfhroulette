name: Quality Checks

# Industry best practice: "Fail fast locally, verify comprehensively remotely"
#
# Local (pre-commit): Lint + format (staged files) - instant feedback
# Local (pre-push): Type check + tests (changed files) - catches logic bugs
# CI (this workflow): Full test suite + E2E + security - comprehensive verification
#
# Note: Lint/format NOT duplicated here - pre-commit already did it
# This avoids redundant work and reduces CI costs

on:
  push:
    branches: [main, master, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.editorconfig'
  pull_request:
    branches: [main, master, develop]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday (security scans)
  workflow_dispatch: # Manual trigger

# Prevent duplicate runs - cancel in-progress when new commit pushed
concurrency:
  group: quality-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
# WORKFLOW_MODE: minimal

jobs:
  # Step 1: Detect project maturity level and package manager
  # Skip for Dependabot PRs - they auto-merge based on their own checks
  # This reduces GitHub Actions minutes by ~50% on active repos
  detect-maturity:
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]' || github.event_name == 'schedule'
    outputs:
      maturity: 'minimal'
      source-count: '10'
      test-count: '1'
      has-deps: 'true'
      has-docs: 'false'
      has-css: 'false'
      package-manager: ${{ steps.detect-pm.outputs.manager }}
      install-cmd: ${{ steps.detect-pm.outputs.install-cmd }}
      is-turborepo: ${{ steps.detect-pm.outputs.is-turborepo }}
      turbo-prefix: ${{ steps.detect-pm.outputs.turbo-prefix }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Detect Package Manager
        id: detect-pm
        run: |
          # Detect package manager from lockfiles
          if [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "install-cmd=pnpm install --frozen-lockfile" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "install-cmd=yarn install --frozen-lockfile" >> $GITHUB_OUTPUT
          elif [ -f bun.lockb ]; then
            echo "manager=bun" >> $GITHUB_OUTPUT
            echo "install-cmd=bun install --frozen-lockfile" >> $GITHUB_OUTPUT
          elif [ -f package-lock.json ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "install-cmd=npm ci" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "install-cmd=npm install" >> $GITHUB_OUTPUT
          fi

          # Detect Turborepo
          if [ -f turbo.json ]; then
            echo "is-turborepo=true" >> $GITHUB_OUTPUT
            echo "turbo-prefix=turbo run" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Turborepo detected - will use 'turbo run' for tasks"
          else
            echo "is-turborepo=false" >> $GITHUB_OUTPUT
            echo "turbo-prefix=" >> $GITHUB_OUTPUT
          fi

      - name: Setup pnpm
        if: steps.detect-pm.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: '8.15.0'

      - name: Setup Bun
        if: steps.detect-pm.outputs.manager == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.0.0'
      - name: Display Detection Report
        run: |
          echo "ðŸ“Š Project Detection Results (Minimal Mode)"
          echo "Package Manager: ${{ steps.detect-pm.outputs.manager }}"
          echo "Install Command: ${{ steps.detect-pm.outputs.install-cmd }}"
          echo "Turborepo: ${{ steps.detect-pm.outputs.is-turborepo }}"
          echo "Note: Maturity detection skipped in minimal mode for faster CI"

  # Note: Lint/format jobs REMOVED - pre-commit already does this locally
  # This follows industry best practice: "Each layer does unique work"
  # Pre-commit = lint + format on staged files
  # CI = full tests + E2E + security (things that can't be done locally)

  # Step 2: Security checks - run if dependencies exist
  #
  # Optional Enhanced Token Configuration:
  # - GITLEAKS_TOKEN: Enhanced GitHub token for gitleaks (fallback: GITHUB_TOKEN)
  # - GITLEAKS_LICENSE: Commercial gitleaks license key for advanced features
  # - SEMGREP_APP_TOKEN: Semgrep app token for enhanced scanning and rate limits
  #
  # These are optional - workflow functions with defaults but enhanced tokens
  # provide better reliability on GHES/self-hosted and unlock premium features
  security:
    runs-on: ubuntu-latest
    needs: detect-maturity
    if: (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && needs.detect-maturity.outputs.has-deps == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: ${{ needs.detect-maturity.outputs.package-manager }}

      - name: Setup pnpm
        if: needs.detect-maturity.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: '8.15.0'

      - name: Setup Bun
        if: needs.detect-maturity.outputs.package-manager == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.0.0'

      - name: Install dependencies
        run: ${{ needs.detect-maturity.outputs.install-cmd }}

      - name: Verify dependency integrity
        run: |
          echo "ðŸ” Verifying dependency integrity..."
          PACKAGE_MANAGER="${{ needs.detect-maturity.outputs.package-manager }}"

          case "$PACKAGE_MANAGER" in
            "pnpm")
              if [ -f pnpm-lock.yaml ]; then
                pnpm install --frozen-lockfile --dry-run
                echo "âœ… Dependency integrity verified (pnpm)"
              else
                echo "âš ï¸ No pnpm-lock.yaml found - skipping integrity verification"
              fi
              ;;
            "yarn")
              if [ -f yarn.lock ]; then
                yarn install --frozen-lockfile --dry-run
                echo "âœ… Dependency integrity verified (yarn)"
              else
                echo "âš ï¸ No yarn.lock found - skipping integrity verification"
              fi
              ;;
            "bun")
              if [ -f bun.lockb ]; then
                bun install --frozen-lockfile --dry-run
                echo "âœ… Dependency integrity verified (bun)"
              else
                echo "âš ï¸ No bun.lockb found - skipping integrity verification"
              fi
              ;;
            "npm"|*)
              if [ -f package-lock.json ]; then
                npm ci --dry-run --prefer-offline
                echo "âœ… Dependency integrity verified (npm)"
              else
                echo "âš ï¸ No package-lock.json found - skipping integrity verification"
              fi
              ;;
          esac

          echo "ðŸ” Checking for vulnerable dependencies..."
          case "$PACKAGE_MANAGER" in
            "pnpm") pnpm audit --audit-level=moderate ;;
            "yarn") yarn audit --level=moderate ;;
            "bun") bun audit --audit-level=moderate ;;
            "npm"|*) npm audit --audit-level=moderate ;;
          esac

      - name: Security audit
        run: |
          PACKAGE_MANAGER="${{ needs.detect-maturity.outputs.package-manager }}"
          echo "ðŸ” Running security audit with $PACKAGE_MANAGER..."

          case "$PACKAGE_MANAGER" in
            "pnpm") pnpm audit --audit-level high ;;
            "yarn") yarn audit --level high ;;
            "bun") bun audit --audit-level high ;;
            "npm"|*) npm audit --audit-level high ;;
          esac

      - name: Production dependencies security audit
        run: |
          PACKAGE_MANAGER="${{ needs.detect-maturity.outputs.package-manager }}"
          echo "ðŸ”’ Running production-only dependency audit with $PACKAGE_MANAGER..."

          case "$PACKAGE_MANAGER" in
            "pnpm") pnpm audit --audit-level high --prod ;;
            "yarn") yarn audit --level high --groups dependencies ;;
            "bun") bun audit --audit-level high --production ;;
            "npm"|*) npm audit --audit-level high --production ;;
          esac

      - name: Check for hardcoded secrets
        run: |
          echo "ðŸ” Running gitleaks secret scanning..."
          # Use setup.js security scan which manages gitleaks binary internally
          # This avoids the commercial license requirement of the gitleaks-action
          if [ -f setup.js ]; then
            node setup.js --security-config
          else
            node node_modules/create-qa-architect/setup.js --security-config
          fi

      - name: Security pattern detection
        uses: semgrep/semgrep-action@713efdd345f3035192eaa63f56867b88e63e4e5d # v1
        with:
          config: >
            p/security-audit@1.85.0
            p/javascript@1.85.0
          cache: true
          cache-key: semgrep-security-audit-1.85.0-javascript-1.85.0-${{ env.SEMGREP_VERSION }}
        env:
          # Use Semgrep app token if available for enhanced features and rate limits
          # Falls back to GitHub token for basic functionality
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SEMGREP_VERSION: '1.85.0'
          SEMGREP_ENABLE_VERSION_CHECK: 'false'

  # Step 3: Tests - run if test files exist (development+)
  # Smart skip: Draft PRs skip tests (saves CI costs during WIP)
  tests:
    runs-on: ubuntu-latest
    needs: detect-maturity
    if: |
      fromJSON(needs.detect-maturity.outputs.test-count) > 0 &&
      (github.event.pull_request.draft != true || github.event_name != 'pull_request')
    strategy:
      fail-fast: false
      matrix:
        node-version: [22]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: ${{ needs.detect-maturity.outputs.package-manager }}

      - name: Setup pnpm
        if: needs.detect-maturity.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: '8.15.0'

      - name: Setup Bun
        if: needs.detect-maturity.outputs.package-manager == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.0.0'

      - name: Install dependencies
        run: |
          echo "â±ï¸ Performance Budget: Dependency installation must complete within 2 minutes"
          timeout 120 ${{ needs.detect-maturity.outputs.install-cmd }} || {
            echo "::error::Dependency installation exceeded 2-minute performance budget!"
            exit 1
          }

      - name: Run tests
        run: |
          echo "ðŸ§ª Running ${{ needs.detect-maturity.outputs.test-count }} test files on Node.js ${{ matrix.node-version }}..."

          # Warn if test count is suspiciously low
          TEST_COUNT=${{ needs.detect-maturity.outputs.test-count }}
          if [ "$TEST_COUNT" -lt 5 ]; then
            echo "::warning::Only $TEST_COUNT test file(s) found - consider adding more tests for better coverage"
          fi

          # Performance budget: Test suite timeout (5 minutes max)
          echo "â±ï¸ Performance Budget: Test suite must complete within 5 minutes"
          timeout 300 npm test || {
            echo "::error::Test suite exceeded 5-minute performance budget!"
            exit 1
          }
            gitleaks-8.28.0-linux-x64-

  # Step 4: Documentation - run for production-ready projects
  documentation:
    runs-on: ubuntu-latest
    needs: detect-maturity
    if: needs.detect-maturity.outputs.maturity == 'production-ready'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: ${{ needs.detect-maturity.outputs.package-manager }}

      - name: Setup pnpm
        if: needs.detect-maturity.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: '8.15.0'

      - name: Setup Bun
        if: needs.detect-maturity.outputs.package-manager == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.0.0'

      - name: Install dependencies
        run: ${{ needs.detect-maturity.outputs.install-cmd }}

      - name: Configuration security check
        run: |
          echo "ðŸ” Running configuration security validation..."
          if [ -f setup.js ]; then
            node setup.js --security-config
          else
            node node_modules/create-qa-architect/setup.js --security-config
          fi

      - name: Documentation validation
        run: |
          echo "ðŸ“– Running documentation validation..."
          if [ -f setup.js ]; then
            node setup.js --validate-docs
          else
            node node_modules/create-qa-architect/setup.js --validate-docs
          fi

      - name: Documentation consistency and security audit freshness
        run: |
          echo "ðŸ” Running comprehensive documentation validation..."
          # This includes security audit freshness check with proper git-based validation
          if [ -f scripts/check-docs.sh ]; then
            bash scripts/check-docs.sh
          else
            bash node_modules/create-qa-architect/scripts/check-docs.sh
          fi

      - name: Package size and contents validation
        if: hashFiles('package.json') != ''
        run: |
          echo "ðŸ“¦ Validating package size and contents..."

          # Check if this is an npm package
          if [ -f package.json ] && grep -q '"name"' package.json; then
            # Dry-run pack to check what would be included
            echo "ðŸ” Checking package contents (dry run):"
            npm pack --dry-run 2>/dev/null | grep -E '^[a-zA-Z]' || echo "No files listed"

            # Calculate estimated pack size
            PACK_SIZE=$(npm pack --dry-run 2>&1 | grep -E 'package size.*[0-9]+' | grep -oE '[0-9.]+\s?(B|kB|MB)' | head -1 || echo "unknown")
            echo "ðŸ“Š Estimated package size: $PACK_SIZE"

            # Warn if package seems too large (>10MB)
            if echo "$PACK_SIZE" | grep -qE '[0-9]+\s?MB'; then
              SIZE_NUM=$(echo "$PACK_SIZE" | grep -oE '[0-9]+')
              if [ "$SIZE_NUM" -gt 10 ]; then
                echo "::warning::Package size ($PACK_SIZE) is quite large. Consider excluding unnecessary files via .npmignore or package.json 'files' field."
              fi
            fi

            # Check for common files that shouldn't be in packages
            echo "ðŸ” Checking for potentially unwanted files..."
            npm pack --dry-run 2>/dev/null | grep -E '\.(log|tmp|cache|DS_Store)$|node_modules/|\.git/' && {
              echo "::warning::Package contains files that might not belong in the published package"
            } || echo "âœ… No obviously unwanted files detected"

            # Validate package.json files field if present
            if grep -q '"files"' package.json; then
              echo "âœ… Package.json 'files' field configured"
            else
              echo "::notice::No 'files' field in package.json - all files except those in .npmignore will be included"
            fi
          else
            echo "â„¹ï¸ Not an npm package or no package.json found - skipping package validation"
          fi

      - name: Detect web app
        id: detect-webapp
        run: |
          # Only run Lighthouse for actual web apps, not CLI tools
          IS_WEBAPP=false

          # Check for web app indicators
          if [ -f "index.html" ] || [ -f "public/index.html" ] || [ -f "src/index.html" ]; then
            IS_WEBAPP=true
          elif [ -d "dist" ] && [ -f "dist/index.html" ]; then
            IS_WEBAPP=true
          elif grep -q '"start".*"next\|vite\|react-scripts\|serve"' package.json 2>/dev/null; then
            IS_WEBAPP=true
          fi

          echo "is-webapp=$IS_WEBAPP" >> $GITHUB_OUTPUT
          echo "Web app detected: $IS_WEBAPP"

      - name: Lighthouse CI
        if: hashFiles('.lighthouserc.js', '.lighthouserc.json', 'lighthouserc.js') != '' && steps.detect-webapp.outputs.is-webapp == 'true'
        id: lighthouse
        run: |
          echo "Running Lighthouse CI..."
          npx lhci autorun
        continue-on-error: true

      - name: Report Lighthouse Failures
        if: steps.lighthouse.outcome == 'failure'
        run: |
          echo "::warning::Lighthouse CI failed - performance budgets or quality thresholds violated"
          echo "Review the Lighthouse report to see which metrics failed."
          echo "Common failures: performance score, accessibility issues, SEO problems"

          # Add to job summary for visibility
          echo "## Lighthouse CI Failed" >> $GITHUB_STEP_SUMMARY
          echo "Performance budgets or quality thresholds were violated." >> $GITHUB_STEP_SUMMARY
          echo "Review the Lighthouse report in the Actions logs above." >> $GITHUB_STEP_SUMMARY

          # Soft warning, not hard fail - Lighthouse issues shouldn't block releases
          # Teams can enforce by adding 'error' level assertions in their lighthouserc
          echo "::notice::Lighthouse failures are warnings. Add 'error' assertions in .lighthouserc.js to enforce."

  # Step 5: Summary - report what checks ran
  summary:
    runs-on: ubuntu-latest
    needs:
      - detect-maturity
      - security
      - tests
      - documentation
    if: always()

    steps:
      - name: Generate Check Summary
        env:
          SECURITY_RESULT: ${{ needs.security.result }}
          TESTS_RESULT: ${{ needs.tests.result }}
          DOCS_RESULT: ${{ needs.documentation.result }}
        run: |
          echo "## Quality Checks Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Maturity Level:** ${{ needs.detect-maturity.outputs.maturity }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Project Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Source files: ${{ needs.detect-maturity.outputs.source-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test files: ${{ needs.detect-maturity.outputs.test-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Has dependencies: ${{ needs.detect-maturity.outputs.has-deps }}" >> $GITHUB_STEP_SUMMARY
          echo "- Has documentation: ${{ needs.detect-maturity.outputs.has-docs }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Lint/format checks run locally in pre-commit (not duplicated here)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Security
          if [ "$SECURITY_RESULT" == "success" ]; then
            echo "- âœ… Security: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$SECURITY_RESULT" == "failure" ]; then
            echo "- âŒ Security: Failed" >> $GITHUB_STEP_SUMMARY
          elif [ "$SECURITY_RESULT" == "skipped" ]; then
            echo "- â­ï¸ Security: Skipped (runs on schedule/manual trigger)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Security: $SECURITY_RESULT" >> $GITHUB_STEP_SUMMARY
          fi

          # Tests
          if [ "$TESTS_RESULT" == "success" ]; then
            echo "- âœ… Tests: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$TESTS_RESULT" == "failure" ]; then
            echo "- âŒ Tests: Failed" >> $GITHUB_STEP_SUMMARY
          elif [ "$TESTS_RESULT" == "skipped" ]; then
            echo "- â­ï¸ Tests: Skipped (no test files)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Tests: $TESTS_RESULT" >> $GITHUB_STEP_SUMMARY
          fi

          # Documentation
          if [ "$DOCS_RESULT" == "success" ]; then
            echo "- âœ… Documentation: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$DOCS_RESULT" == "failure" ]; then
            echo "- âŒ Documentation: Failed" >> $GITHUB_STEP_SUMMARY
          elif [ "$DOCS_RESULT" == "skipped" ]; then
            echo "- â­ï¸ Documentation: Skipped (not production-ready)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Documentation: $DOCS_RESULT" >> $GITHUB_STEP_SUMMARY
          fi
            # PR comment step not enabled (use --pr-comments to add)

  # Slack alerts not enabled (use --alerts-slack to add)
